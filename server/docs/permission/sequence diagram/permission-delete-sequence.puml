@startuml Permission - Delete Sequence
!theme plain
skinparam backgroundColor #FFFFFF
skinparam sequenceArrowThickness 2
skinparam roundcorner 16

title Chi Tiết Luồng DELETE /permissions/:permissionId

actor "Admin" as A
participant "PermissionController" as PC
participant "ActiveUser" as AU
participant "PermissionService" as PS
participant "PermissionRepo" as PR
participant "CacheManager" as CM
participant "I18nService" as IS
database "PostgreSQL (Prisma)" as DB
database "Redis" as RD

A -> PC: DELETE /permissions/:permissionId
activate PC

PC -> AU: @ActiveUser()
AU --> PC: user

PC -> PS: delete({ id, user })
activate PS

PS -> PR: delete({ id, deletedById: user.userId })
activate PR
PR -> DB: permission.update({ where: { id, deletedAt: null }, data: { deletedAt: now, deletedById }, include: roles })
DB --> PR: deleted permission (kèm roles)
PR --> PS: deleted permission (kèm roles)
deactivate PR

PS -> PS: deleteCachedRole(roles)
PS -> CM: del(`role:${roleId}`) cho từng role
CM -> RD: Delete cache entries
RD --> CM: ok

PS -> IS: i18n.t('permission.permission.success.DELETE_SUCCESS')
IS --> PS: message
PS --> PC: { message }
deactivate PS

PC --> A: 200 OK + JSON
deactivate PC

@enduml


