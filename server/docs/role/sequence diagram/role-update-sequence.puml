@startuml Role - Update Sequence
!theme plain
skinparam backgroundColor #FFFFFF
skinparam sequenceArrowThickness 2
skinparam roundcorner 16

title Chi Tiết Luồng PUT /roles/:roleId

actor "Admin" as A
participant "RoleController" as RC
participant "ActiveUser" as AU
participant "RoleService" as RS
participant "RoleRepo" as RR
participant "CacheManager" as CM
participant "I18nService" as IS
database "PostgreSQL (Prisma)" as DB
database "Redis" as RD

A -> RC: PUT /roles/:roleId { data }
activate RC

RC -> AU: @ActiveUser()
AU --> RC: user

RC -> RS: update({ id, data, user })
activate RS

RS -> RS: verifyRole(id) (base role protection)
alt Role là base role
  RS --> RC: ProhibitedActionOnBaseRoleException (403)
  RC --> A: 403 Forbidden
  deactivate RS
  deactivate RC
  stop
end

RS -> RR: update({ id, updatedById: user.userId, data })
activate RR
note right of RR
Nếu có permissionIds:
• findMany permissions theo IDs
• Nếu permission đã bị soft delete → throw Error
end note
RR -> DB: role.update({ where: { id, deletedAt: null }, data: { ...fields, permissions.set(permissionIds), updatedById }, include: permissions (deletedAt=null) })
DB --> RR: updatedRole
RR --> RS: updatedRole
deactivate RR

RS -> CM: del(`role:${updatedRole.id}`)
CM -> RD: Delete cache entries
RD --> CM: ok

RS -> IS: i18n.t('role.role.success.UPDATE_SUCCESS')
IS --> RS: message
RS --> RC: { message, data: updatedRole }
deactivate RS

RC --> A: 200 OK + JSON
deactivate RC

@enduml


