@startuml Media Management Activity Diagram
!theme plain
skinparam backgroundColor #FFFFFF
skinparam activityFontSize 12
skinparam activityFontColor #333333
skinparam activityBorderColor #666666
skinparam activityBackgroundColor #F0F0F0
skinparam activityDiamondBackgroundColor #FFE6E6
skinparam activityDiamondBorderColor #CC0000

title Quản Lý Media - Sơ Đồ Hoạt Động

start

:Khách hàng yêu cầu thao tác media;

if (Loại thao tác?) then (POST /media/images/upload)
  :Nhận multipart form data với files;
  :Xác thực số lượng file (tối đa 100 files);
  if (Số lượng file hợp lệ?) then (có)
    :Multer xử lý file upload;
    :Lưu files vào UPLOAD_DIR;
    :Tạo tên file ngẫu nhiên;
    :ParseFilePipeWithUnlink validation;
    if (Xác thực file thành công?) then (có)
      :Xác thực kích thước file (tối đa 1MB);
      if (Kích thước file hợp lệ?) then (có)
        :Xác thực loại file (jpg, jpeg, png, webp);
        if (Loại file hợp lệ?) then (có)
          :Xử lý files song song với Promise.all;
          :Upload files lên S3;
          note right
          Quá Trình Upload S3:
          • Tạo S3 key: 'images/' + filename
          • Upload với content type phù hợp
          • Xử lý nhiều files đồng thời
          • Trích xuất S3 Location URL
          end note
          :Dọn dẹp files local với Promise.all;
          :unlink(file.path) cho mỗi file;
          :Tạo phản hồi với S3 URLs;
          :Trả về upload thành công;
        else (không)
          :Tự động dọn dẹp files;
          :Trả về lỗi "Loại file không hợp lệ";
        endif
      else (không)
        :Tự động dọn dẹp files;
        :Trả về lỗi "Kích thước file quá lớn";
      endif
    else (không)
      :Tự động dọn dẹp files;
      :Trả về lỗi xác thực;
    endif
  else (không)
    :Trả về lỗi "Quá nhiều files";
  endif

elseif (GET /media/static/:filename)
  :Trích xuất filename từ params;
  :Kiểm tra file tồn tại tại UPLOAD_DIR;
  if (File tồn tại?) then (có)
    :Phục vụ file với res.sendFile();
    :Stream nội dung file;
    :Trả về file stream;
  else (không)
    :Trả về 404 Not Found;
  endif

elseif (POST /media/images/upload/presigned-url)
  :Trích xuất {filename, filesize} từ body;
  :Xác thực request body;
  if (Xác thực thành công?) then (có)
    :Xác thực filesize (tối đa 1MB);
    if (Filesize hợp lệ?) then (có)
      :Tạo tên file ngẫu nhiên;
      :Tạo presigned URL với S3;
      note right
      Tạo Presigned URL:
      • Tạo tên file ngẫu nhiên duy nhất
      • Tạo S3 presigned URL
      • Thiết lập thời gian hết hạn phù hợp
      • Cho phép upload trực tiếp lên S3
      end note
      :Trích xuất base URL từ presigned URL;
      :Tách tại '?' để lấy base URL;
      :Trả về presignedUrl và url;
    else (không)
      :Trả về lỗi "Filesize quá lớn";
    endif
  else (không)
    :Trả về lỗi xác thực;
  endif

else (Thao tác không hợp lệ)
  :Ném InvalidOperationException;
endif

:Tạo thông báo thành công đa ngôn ngữ;
:Trả về JSON response với metadata;

stop

@enduml
