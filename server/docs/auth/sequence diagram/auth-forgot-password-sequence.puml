@startuml Auth - Forgot Password Sequence
!theme plain
skinparam backgroundColor #FFFFFF
skinparam sequenceArrowThickness 2
skinparam roundcorner 16

title Chi Tiết Luồng POST /auth/forgot-password

actor "Client" as C
participant "AuthController" as AC
participant "AuthService" as AS
participant "SharedUserRepository" as SUR
participant "AuthRepository" as AR
participant "HashingService" as HS
database "PostgreSQL (Prisma)" as DB

C -> AC: POST /auth/forgot-password { email, code, newPassword, confirmNewPassword }
activate AC

AC -> AS: forgotPassword(body)
activate AS

AS -> SUR: findUnique({ email })
SUR -> DB: user.findFirst()
DB --> SUR: user | null
SUR --> AS: user | null
alt user == null
  AS --> AC: EmailNotFoundException (422)
  AC --> C: 422 Unprocessable Entity
  deactivate AS
  deactivate AC
  stop
end

AS -> AS: validateVerificationCode({ email, type: FORGOT_PASSWORD })
AS -> HS: hash(newPassword)
HS --> AS: hashed
par update password
  AS -> SUR: update({ id: user.id }, { password: hashed, updatedById: user.id })
  SUR -> DB: user.update()
  DB --> SUR: user
  SUR --> AS: ok
and delete verification code
  AS -> AR: deleteVerificationCode({ email_type: { email, type: FORGOT_PASSWORD } })
  AR -> DB: verificationCode.delete()
  DB --> AR: ok
  AR --> AS: ok
end

AS --> AC: { message: 'Đổi mật khẩu thành công' }
deactivate AS

AC --> C: 200 OK + JSON
deactivate AC

@enduml


