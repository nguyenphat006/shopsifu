@startuml Manage Product Create Sequence
!theme plain
skinparam backgroundColor #FFFFFF
skinparam sequenceArrowThickness 2
skinparam roundcorner 16

title Chi Tiết Luồng POST /manage-product/products

actor "ShopOwner/Admin" as U
participant "AccessTokenGuard" as AG
participant "ManageProductController" as MPC
participant "ManageProductService" as MPS
participant "ProductRepo" as PR
participant "SearchSyncService" as SSS
participant "I18nService" as IS
database "PostgreSQL (Prisma)" as DB
queue "BullMQ (search-sync)" as Q

U -> AG: Request + access_token
AG -> AG: Validate JWT, load user context
AG --> MPC: Forward với user
activate MPC

MPC -> MPS: create({ data, user })
activate MPS

note right of MPS
Body gồm: publishedAt, name, description, basePrice,\nvirtualPrice, brandId, images, variants, specifications,\ncategories[], skus[] (theo UpsertSKUBodySchema)
SuperRefine validate SKUs vs variants trong DTO layer
end note

MPS -> PR: create({ createdById: user.userId, data })
activate PR
PR -> DB: product.create({ data: { ...productData,\n categories.connect, skus.createMany({ createdById }) }, include: relations })
DB --> PR: created product (kèm translations/skus/brand/categories)
PR -> SSS: addSyncProductJob(product.id, 'create')
SSS -> Q: enqueue SYNC_PRODUCT_JOB
SSS --> PR: ok (log)
PR --> MPS: { data: product }
deactivate PR

MPS -> IS: t('product.product.success.CREATE_SUCCESS')
IS --> MPS: message
MPS --> MPC: { message, data: product.data }
deactivate MPS

MPC --> U: 201 Created + JSON
deactivate MPC

@enduml


