@startuml Manage Product Update Sequence
!theme plain
skinparam backgroundColor #FFFFFF
skinparam sequenceArrowThickness 2
skinparam roundcorner 16

title Chi Tiết Luồng PUT /manage-product/products/:productId

actor "ShopOwner/Admin" as U
participant "AccessTokenGuard" as AG
participant "ManageProductController" as MPC
participant "ManageProductService" as MPS
participant "ProductRepo" as PR
participant "SearchSyncService" as SSS
participant "I18nService" as IS
database "PostgreSQL (Prisma)" as DB
queue "BullMQ (search-sync)" as Q

U -> AG: Request + access_token
AG -> AG: Validate JWT, load user context
AG --> MPC: Forward với user
activate MPC

MPC -> MPS: update({ productId, data, user })
activate MPS

MPS -> PR: findById(productId)
activate PR
PR -> DB: product.findUnique({ where: { id, deletedAt: null } })
DB --> PR: product | null
PR --> MPS: product | null
deactivate PR

alt product == null
  MPS -> MPS: throw NotFoundRecordException
  MPS --> MPC: 404 Not Found
  MPC --> U: 404 Not Found
  deactivate MPS
  deactivate MPC
  stop
end

MPS -> MPS: validatePrivilege(userIdRequest=user.userId,\n roleNameRequest=user.roleName,\n createdById=product.createdById)

alt Không hợp lệ
  MPS -> MPS: throw ForbiddenException
  MPS --> MPC: 403 Forbidden
  MPC --> U: 403 Forbidden
  deactivate MPS
  deactivate MPC
  stop
end

note right of PR
Logic cập nhật SKUs (trong ProductRepo.update):
1) existingSKUs = sKU.findMany(productId, deletedAt=null)
2) skusToDelete = existingSKUs - dataSkus (theo value)
3) skusWithId = map dataSkus với id nếu value trùng
4) skusToUpdate = skusWithId có id
5) skusToCreate = skusWithId không có id => createMany
end note

MPS -> PR: update({ id=productId, updatedById=user.userId, data })
activate PR
PR -> DB: $transaction([
  product.update({ data: { ...productData, updatedById, categories.connect } }),
  sKU.updateMany({ where: id in skuIdsToDelete, data: { deletedAt, deletedById } }),
  ...sKU.update({ id, data }) for skusToUpdate,
  sKU.createMany(skusToCreate)
])
DB --> PR: updated product
PR -> SSS: addSyncProductJob(productId, 'update')
SSS -> Q: enqueue SYNC_PRODUCT_JOB
SSS --> PR: ok
PR --> MPS: product
deactivate PR

MPS -> IS: t('product.product.success.UPDATE_SUCCESS')
IS --> MPS: message
MPS --> MPC: { message, data: product }
deactivate MPS

MPC --> U: 200 OK + JSON
deactivate MPC

@enduml


