@startuml Manage Product Update Activity
!theme plain
skinparam backgroundColor #FFFFFF
skinparam activityFontSize 12
skinparam activityFontColor #333333
skinparam activityBorderColor #666666
skinparam activityBackgroundColor #F7F7F7

title Hoạt Động: PUT /manage-product/products/:productId

start
:Xác thực AccessToken và tải user context;
:Nhận productId + body { productData, categories[], skus[] };
:Tìm product theo ID;
if (Product tồn tại?) then (Có)
  :Kiểm tra quyền: user.userId == createdById hoặc roleName == Admin?;
  if (Hợp lệ?) then (Có)
    :Tải existing SKUs;
    :Tìm skusToDelete (existing - payload by value);
    :Map id vào payload (skusWithId);
    :Phân loại skusToUpdate và skusToCreate;
    :$transaction: update product + soft delete skusToDelete + update skusToUpdate + createMany skusToCreate;
    :enqueue addSyncProductJob(productId, 'update');
    :Build message i18n;
    :Trả về 200 { message, data };
  else (Không)
    :Ném ForbiddenException;
  endif
else (Không)
  :Ném NotFoundRecordException;
endif
stop

@enduml


