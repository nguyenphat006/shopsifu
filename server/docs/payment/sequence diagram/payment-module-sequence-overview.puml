@startuml Payment Module - Sequence Overview
!theme plain
skinparam backgroundColor #FFFFFF
skinparam sequenceArrowThickness 2
skinparam roundcorner 20
skinparam maxmessagesize 60

title Mô-đun Thanh Toán - Tổng Quan Luồng Xử Lý
note top : Hệ thống thanh toán đa cổng với VNPay và Sepay, hỗ trợ webhook và real-time notifications

actor "Khách hàng" as Client
actor "VNPay Gateway" as VNG
actor "Sepay Gateway" as SG
participant "VNPayController" as VC
participant "SepayController" as SC
participant "VNPayService" as VS
participant "SepayService" as SS
participant "VNPayRepo" as VR
participant "SepayRepo" as SR
participant "VnpayService" as VNS
participant "SharedPaymentRepository" as SPR
participant "SharedWebsocketRepository" as SWR
participant "I18nService" as IS
participant "PaymentAPIKeyGuard" as AG
database "PostgreSQL" as DB
database "WebSocket Server" as WS

== VNPay Payment Flow ==
Client -> VC: GET /payment/vnpay/bank-list
VC -> VS: getBankList()
VS -> VNS: getBankList()
VNS -> VS: return banks data
VS -> IS: i18n.t('payment.payment.vnpay.success.GET_BANK_LIST_SUCCESS')
IS -> VS: Trả về message đã localize
VS -> VC: return banks list
VC -> Client: return banks data

Client -> VC: POST /payment/vnpay/create-payment + {amount, orderInfo, orderId, returnUrl, ipnUrl, locale, currency, bankCode, orderType, ipAddr}
VC -> VS: createPayment(paymentData)
VS -> VS: Xây dựng dữ liệu thanh toán với PREFIX_PAYMENT_CODE
note right
Xây Dựng Dữ Liệu Thanh Toán:
• orderInfoWithPrefix = PREFIX_PAYMENT_CODE + paymentId
• orderIdWithPrefix = PREFIX_PAYMENT_CODE + paymentId
• vnp_Amount, vnp_OrderInfo, vnp_TxnRef
• vnp_IpAddr, vnp_ReturnUrl, vnp_Locale
• vnp_CurrCode, vnp_OrderType
end note
VS -> VNS: buildPaymentUrl(buildPaymentData, {withHash: true})
VNS -> VNS: Tạo URL thanh toán với chữ ký
VNS -> VS: return paymentUrl
VS -> IS: i18n.t('payment.payment.vnpay.success.CREATE_PAYMENT_SUCCESS')
IS -> VS: Trả về message đã localize
VS -> VC: return paymentUrl với message
VC -> Client: return paymentUrl

Client -> VNG: Chuyển hướng đến URL thanh toán
VNG -> Client: Hiển thị form thanh toán
Client -> VNG: Gửi thanh toán
VNG -> Client: Xử lý thanh toán
VNG -> Client: Chuyển hướng đến URL trả về

Client -> VC: GET /payment/vnpay/verify-return + tham số truy vấn
VC -> VS: verifyReturnUrl(queryData)
VS -> VNS: verifyReturnUrl(data)
VNS -> VS: return kết quả xác thực

alt Thanh toán thành công (ResponseCode = '00')
    VS -> VR: processVNPayWebhook(data)
    VR -> VR: Kiểm tra giao dịch trùng lặp
    note right
    Kiểm Tra Trùng Lặp:
    • Tìm giao dịch hiện có theo gateway='vnpay' và referenceNumber
    • Ném BadRequestException nếu đã xử lý
    end note
    VR -> DB: Kiểm tra paymentTransaction
    DB -> VR: Không có giao dịch hiện có
    VR -> VR: Bắt đầu giao dịch database
    VR -> DB: CREATE paymentTransaction
    note right
    Dữ Liệu Giao Dịch:
    • gateway: 'vnpay'
    • amountIn: vnp_Amount / 100 (chuyển đổi VND)
    • amountOut: 0
    • code: vnp_TxnRef
    • transactionContent: vnp_OrderInfo
    • referenceNumber: vnp_TransactionNo
    • body: JSON.stringify(vnpayData)
    end note
    VR -> SPR: extractPaymentId(PREFIX_PAYMENT_CODE, vnp_OrderInfo, vnp_TxnRef)
    SPR -> VR: return paymentId
    VR -> SPR: validateAndFindPayment(paymentId)
    SPR -> DB: Truy vấn payment với orders
    DB -> SPR: Dữ liệu payment và orders
    SPR -> VR: return {payment, orders}
    VR -> SPR: validatePaymentAmount(orders, totalPrice, actualAmount)
    SPR -> VR: Xác thực số tiền thành công
    VR -> SPR: updatePaymentAndOrdersOnSuccess(paymentId, orders)
    SPR -> DB: UPDATE trạng thái payment thành SUCCESS
    SPR -> DB: UPDATE trạng thái orders thành PAID
    VR -> VS: return {userId, paymentId}
    VS -> VS: generateRoomPaymentId(paymentId)
    VS -> WS: server.to(roomId).emit('payment')
    WS -> Client: Thông báo WebSocket
    VS -> IS: i18n.t('payment.payment.vnpay.success.VERIFY_RETURN_SUCCESS')
    IS -> VS: Trả về message đã localize
    VS -> VC: return phản hồi thành công
    VC -> Client: return thành công

else Thanh toán thất bại
    VS -> VC: return phản hồi thất bại
    VC -> Client: return thất bại
end

VNG -> VC: GET /payment/vnpay/verify-ipn + tham số truy vấn
VC -> VS: processIpnCall(queryData)
VS -> VNS: verifyIpnCall(data)
VNS -> VS: return kết quả xác thực

alt IPN đã xác thực
    VS -> VR: verifyIpnCall(data)
    VR -> SPR: extractPaymentId(PREFIX_PAYMENT_CODE, vnp_TxnRef, vnp_OrderInfo)
    SPR -> VR: return paymentId
    VR -> SPR: validateAndFindPayment(paymentId)
    SPR -> DB: Truy vấn payment với orders
    DB -> SPR: Dữ liệu payment và orders
    SPR -> VR: return {payment, orders}
    VR -> SPR: validatePaymentAmount(orders, totalPrice, actualAmount)
    SPR -> VR: Xác thực số tiền thành công
    VR -> VS: return {payment, orders, paymentId}
    VS -> VS: Kiểm tra trạng thái payment
    alt Payment chưa xử lý
        if (Response code là 00?) then (có)
            VS -> VR: updatePaymentAndOrdersOnSuccess(paymentId, orders)
            VR -> SPR: updatePaymentAndOrdersOnSuccess(paymentId, orders)
            SPR -> DB: UPDATE payment thành SUCCESS
            SPR -> DB: UPDATE orders thành PAID
            VS -> VS: generateRoomPaymentId(paymentId)
            VS -> WS: server.to(roomId).emit('payment')
            WS -> Client: Thông báo WebSocket
        else (không)
            VS -> VR: updatePaymentAndOrdersOnFailed(paymentId, orders)
            VR -> SPR: updatePaymentAndOrdersOnFailed(paymentId, orders)
            SPR -> DB: UPDATE payment thành FAILED
            SPR -> DB: UPDATE orders thành CANCELLED
        endif
        VS -> VNG: return RspCode: 00, Message: Confirm Success
    else (đã xử lý)
        VS -> VNG: return RspCode: 02, Message: Order already confirmed
    endif
else (xác thực thất bại)
    VS -> VNG: return RspCode: 97, Message: Invalid Checksum
end

== Sepay Payment Flow ==
SG -> AG: POST /payment/receiver + webhook data
AG -> AG: Xác thực PaymentAPIKey
AG -> SC: Cho phép request
SC -> SS: receiver(body)
SS -> SR: receiver(body)
SR -> SR: Kiểm tra giao dịch trùng lặp
note right
Kiểm Tra Trùng Lặp:
• Tìm giao dịch hiện có theo id
• Ném BadRequestException nếu đã xử lý
end note
SR -> DB: Kiểm tra paymentTransaction
DB -> SR: Không có giao dịch hiện có
SR -> SR: Bắt đầu giao dịch database
SR -> DB: CREATE paymentTransaction
note right
Dữ Liệu Giao Dịch:
• id: body.id
• gateway: body.gateway
• amountIn/amountOut dựa trên transferType
• transactionDate: parse từ body.transactionDate
• accountNumber: body.accountNumber
• subAccount: body.subAccount
• accumulated: body.accumulated
• code: body.code
• transactionContent: body.content
• referenceNumber: body.referenceCode
• body: body.description
end note
SR -> SPR: extractPaymentId(PREFIX_PAYMENT_CODE, body.code, body.content)
SPR -> SR: return paymentId
SR -> SPR: validateAndFindPayment(paymentId)
SPR -> DB: Truy vấn payment với orders
DB -> SPR: Dữ liệu payment và orders
SPR -> SR: return {payment, orders}
SR -> SPR: validatePaymentAmount(orders, totalPrice, transferAmount)
SPR -> SR: Xác thực số tiền thành công
SR -> SPR: updatePaymentAndOrdersOnSuccess(paymentId, orders)
SPR -> DB: UPDATE trạng thái payment thành SUCCESS
SPR -> DB: UPDATE trạng thái orders thành PAID
SR -> SS: return {userId, paymentId}
SS -> SS: generateRoomPaymentId(paymentId)
SS -> WS: server.to(roomId).emit('payment')
WS -> Client: Thông báo WebSocket
SS -> IS: i18n.t('payment.payment.sepay.success.RECEIVER_SUCCESS')
IS -> SS: Trả về message đã localize
SS -> SC: return success response
SC -> SG: return success response

== Additional VNPay Operations ==
Client -> VC: POST /payment/vnpay/query-dr + {orderId, orderInfo, requestId, transactionDate, transactionNo, ipAddr, createDate}
VC -> VS: queryDr(queryData)
VS -> VNS: queryDr(queryRequest)
VNS -> VS: return kết quả truy vấn
VS -> IS: i18n.t('payment.payment.vnpay.success.QUERY_DR_SUCCESS')
IS -> VS: Trả về message đã localize
VS -> VC: return kết quả truy vấn
VC -> Client: return kết quả truy vấn

Client -> VC: POST /payment/vnpay/refund + {orderId, orderInfo, amount, requestId, transactionNo, ipAddr, createBy}
VC -> VS: refund(refundData)
VS -> VNS: refund(refundRequest)
VNS -> VS: return kết quả hoàn tiền
VS -> IS: i18n.t('payment.payment.vnpay.success.REFUND_SUCCESS')
IS -> VS: Trả về message đã localize
VS -> VC: return kết quả hoàn tiền
VC -> Client: return kết quả hoàn tiền

== Xử Lý Lỗi ==
alt Chữ ký không hợp lệ
    VS -> VC: VNPayInvalidChecksumException
    VC -> Client: 422 Unprocessable Entity

else Yêu cầu trùng lặp
    VS -> VC: VNPayDuplicateRequestException
    VC -> Client: 400 Bad Request

else Giao dịch không tìm thấy
    VS -> VC: VNPayTransactionNotFoundException
    VC -> Client: 422 Unprocessable Entity

else Hoàn tiền đã xử lý
    VS -> VC: VNPayRefundAlreadyProcessedException
    VC -> Client: 400 Bad Request

else Dịch vụ không khả dụng
    VS -> VC: VNPayServiceUnavailableException
    VC -> Client: 500 Internal Server Error

else Sepay validation errors
    SR -> SS: BadRequestException
    SS -> SC: Throw exception
    SC -> SG: return error response
end

== WebSocket Real-time Notifications ==
alt Payment thành công
    VS/SS -> WS: server.to(roomId).emit('payment')
    WS -> Client: {status: 'success', gateway: 'vnpay/sepay', paymentId}
    note right
    WebSocket Event:
    • Chỉ client join payment room mới nhận
    • Real-time notification
    • Không emit khi thất bại
    end note
end

note bottom
**Đặc điểm chính của module Payment:**
• Multi-gateway support (VNPay, Sepay)
• Webhook và IPN processing
• Real-time WebSocket notifications
• Payment validation và amount verification
• Transaction management với database
• Comprehensive error handling
• Security với API key authentication
end note

@enduml
